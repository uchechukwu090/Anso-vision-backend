#!/usr/bin/env python3
"""
üîç TEST SIGNAL FLOW - Debug script to verify signals reach MT5 backend
This helps identify WHERE signals are getting blocked
"""

import requests
import json
from datetime import datetime

# Configuration
ANSO_BACKEND = "http://localhost:5000"  # Local: http://localhost:5000 OR Render: https://anso-vision-backend.onrender.com
MT5_BACKEND = "http://localhost:8000"   # Local: http://localhost:8000 OR Render: https://ansorade-backend.onrender.com
API_KEY = "Mr.creative090"

# Test data (EURUSD 1-hour candles - example)
TEST_CANDLES = [
    {"timestamp": "2025-01-01T00:00:00Z", "open": 1.0800, "high": 1.0805, "low": 1.0795, "close": 1.0802, "volume": 100},
    {"timestamp": "2025-01-01T01:00:00Z", "open": 1.0802, "high": 1.0810, "low": 1.0800, "close": 1.0808, "volume": 120},
    # ... would need 250+ candles for real testing
]

def print_section(title):
    """Print formatted section header"""
    print(f"\n{'='*70}")
    print(f"  {title}")
    print(f"{'='*70}\n")

def test_anso_health():
    """Check if Anso Vision Backend is running"""
    print_section("1Ô∏è‚É£ ANSO VISION BACKEND HEALTH")
    
    try:
        response = requests.get(f"{ANSO_BACKEND}/health", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ ANSO BACKEND IS RUNNING")
            print(f"   Status: {data.get('status')}")
            print(f"   Service: {data.get('service')}")
            print(f"   Version: {data.get('version')}")
            return True
        else:
            print(f"‚ùå ANSO BACKEND ERROR: {response.status_code}")
            return False
    except requests.exceptions.ConnectionError:
        print(f"‚ùå CANNOT REACH ANSO BACKEND at {ANSO_BACKEND}")
        print(f"   Is it running? Try: python api_server_integrated.py")
        return False
    except Exception as e:
        print(f"‚ùå ERROR: {e}")
        return False

def test_mt5_health():
    """Check if MT5 Community Trading Backend is running"""
    print_section("2Ô∏è‚É£ MT5 COMMUNITY TRADING BACKEND HEALTH")
    
    try:
        response = requests.get(f"{MT5_BACKEND}/health", headers={"X-API-Key": API_KEY}, timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ MT5 BACKEND IS RUNNING")
            print(f"   Status: {data.get('status')}")
            print(f"   Database: {data.get('database')}")
            print(f"   API Key: {data.get('api_key')}")
            return True
        else:
            print(f"‚ùå MT5 BACKEND ERROR: {response.status_code}")
            return False
    except requests.exceptions.ConnectionError:
        print(f"‚ùå CANNOT REACH MT5 BACKEND at {MT5_BACKEND}")
        print(f"   Is it running? Try: docker-compose up")
        return False
    except Exception as e:
        print(f"‚ùå ERROR: {e}")
        return False

def test_manual_signal_send():
    """Test sending a signal manually to MT5 backend"""
    print_section("3Ô∏è‚É£ SEND TEST SIGNAL TO MT5 BACKEND")
    
    payload = {
        "symbol": "EURUSD",
        "action": "BUY",
        "volume": 0.01,
        "sl": 1.0800,
        "tp": 1.0900,
        "confidence": 0.95,
        "timeframe": "1H"
    }
    
    print(f"Sending signal:")
    print(json.dumps(payload, indent=2))
    print()
    
    try:
        response = requests.post(
            f"{MT5_BACKEND}/api/signal",
            json=payload,
            headers={
                "X-API-Key": API_KEY,
                "Content-Type": "application/json"
            },
            timeout=5
        )
        
        print(f"Response Status: {response.status_code}")
        print(f"Response Body: {response.text}\n")
        
        if response.status_code == 200:
            data = response.json()
            signal_id = data.get('signal_id')
            print(f"‚úÖ SIGNAL RECEIVED BY MT5 BACKEND")
            print(f"   Signal ID: {signal_id}")
            print(f"   Next: Check /api/signals/pending to see if EA polls it")
            return True
        elif response.status_code == 403:
            print(f"‚ùå AUTHENTICATION ERROR: Invalid API key")
            print(f"   Check X-API-Key header matches API_SECRET_KEY")
            return False
        else:
            print(f"‚ùå ERROR: {response.status_code}")
            return False
    
    except requests.exceptions.ConnectionError:
        print(f"‚ùå CANNOT REACH MT5 BACKEND at {MT5_BACKEND}")
        return False
    except Exception as e:
        print(f"‚ùå ERROR: {e}")
        return False

def test_pending_signals():
    """Check if signals are pending in MT5 backend"""
    print_section("4Ô∏è‚É£ CHECK PENDING SIGNALS IN MT5 BACKEND")
    
    print(f"This is what the Expert Advisor polls every second...\n")
    
    try:
        response = requests.get(
            f"{MT5_BACKEND}/api/signals/pending",
            headers={"X-API-Key": API_KEY},
            timeout=5
        )
        
        print(f"Response Status: {response.status_code}\n")
        
        if response.status_code == 200:
            signals = response.json()
            if signals:
                print(f"‚úÖ FOUND {len(signals)} PENDING SIGNAL(S):")
                for sig in signals:
                    print(f"\n   Signal ID: {sig.get('id')}")
                    print(f"   Symbol: {sig.get('symbol')}")
                    print(f"   Action: {sig.get('action')}")
                    print(f"   Volume: {sig.get('volume')}")
                    print(f"   Status: {sig.get('status')}")
                    print(f"   Confidence: {sig.get('confidence')}")
            else:
                print(f"‚ö†Ô∏è NO PENDING SIGNALS")
                print(f"   Either no signals sent, or EA already picked them up")
        else:
            print(f"‚ùå ERROR: {response.status_code}")
    
    except Exception as e:
        print(f"‚ùå ERROR: {e}")

def test_account_stats():
    """Check account balance and stats"""
    print_section("5Ô∏è‚É£ CHECK ACCOUNT STATS IN MT5 BACKEND")
    
    try:
        response = requests.get(
            f"{MT5_BACKEND}/api/account/stats",
            timeout=5
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ ACCOUNT STATS:")
            print(json.dumps(data, indent=2))
        else:
            print(f"‚ùå ERROR: {response.status_code}")
    
    except Exception as e:
        print(f"‚ùå ERROR: {e}")

def print_summary(anso_ok, mt5_ok, signal_sent):
    """Print summary of test results"""
    print_section("üìã TEST SUMMARY")
    
    print(f"Anso Backend:          {'‚úÖ OK' if anso_ok else '‚ùå FAILED'}")
    print(f"MT5 Backend:           {'‚úÖ OK' if mt5_ok else '‚ùå FAILED'}")
    print(f"Signal Send Test:      {'‚úÖ OK' if signal_sent else '‚ùå FAILED'}")
    print()
    
    if not anso_ok:
        print("‚ö†Ô∏è  Anso Vision Backend is not running")
        print("   Start it: python api_server_integrated.py")
        print()
    
    if not mt5_ok:
        print("‚ö†Ô∏è  MT5 Community Trading Backend is not running")
        print("   Start it: docker-compose up")
        print()
    
    if anso_ok and mt5_ok and signal_sent:
        print("‚úÖ ALL SYSTEMS OK!")
        print("   Signals should be flowing from Anso ‚Üí MT5")
        print("   Check logs in both terminals for details")
    elif anso_ok and mt5_ok:
        print("‚ö†Ô∏è  Both backends are running but signal send failed")
        print("   Check API key and endpoint configuration")
    
    print()

if __name__ == "__main__":
    print("\n" + "="*70)
    print("  üîç SIGNAL FLOW TEST - Debug Signal Path")
    print("="*70)
    print(f"\nTime: {datetime.now().isoformat()}")
    print(f"Anso Backend: {ANSO_BACKEND}")
    print(f"MT5 Backend:  {MT5_BACKEND}")
    print(f"API Key:      {API_KEY}")
    
    # Run tests
    anso_ok = test_anso_health()
    mt5_ok = test_mt5_health()
    signal_sent = False
    
    if mt5_ok:
        signal_sent = test_manual_signal_send()
        test_pending_signals()
        test_account_stats()
    
    # Print summary
    print_summary(anso_ok, mt5_ok, signal_sent)
